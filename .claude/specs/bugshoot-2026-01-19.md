# Clarvis Sidebar Features & Bug Fixes

## Overview

This spec covers a set of UI/UX improvements and bug fixes for the Clarvis sidebar, focusing on session management, search/filtering, and permission controls. The work includes fixing broken features (detailed view toggle, directory selection modal), adding new capabilities (per-workdir new session button, search box, refresh button, permission mode dropdown), and implementing auto-naming for unnamed sessions.

## Goals

- Fix the broken "detailed view" button to properly toggle agent activity (CoT, tool calls)
- Fix the directory selection modal that disappears prematurely (modal stacking issue)
- Add per-workdir "new session" (+) button that pre-populates the working directory
- Add client-side fuzzy search filtering using Fuse.js
- Add permission mode dropdown in session header with confirmation for dangerous modes
- Add refresh button in sidebar header (plus pull-to-refresh on mobile)
- Auto-name sessions from first user message (up to 128 chars) when no name is provided
- Create documentation with Playwright screenshots

## Non-Goals

- Server-side search (client-side only)
- Automated screenshot capture (manual during development)
- Complex permission systems beyond standard Claude Code modes

## Requirements

### 1. Per-Workdir New Session Button (+)
- Position: Inline with workdir header, right-aligned
- Behavior: Opens new session modal with working directory pre-populated
- User can still change the directory in the modal if desired

### 2. Sidebar Search Box
- Client-side filtering using Fuse.js library
- Fuzzy matches against:
  - Session names
  - Workdir names (all sessions in matching workdir show)
- Auto-expand workdirs that have matching sessions
- Empty results: Show empty sidebar (no special message)
- Keyboard shortcuts:
  - Cmd/Ctrl+K to focus search box
  - Escape to clear search and unfocus
  - Arrow keys to navigate filtered results

### 3. Detailed View Button Fix
- Currently broken - needs investigation and fix
- Should toggle visibility of agent activity (CoT, tool calls)
- Similar to Claude Code's Ctrl+O functionality

### 4. Permission Mode UX
- Dropdown in session header showing current permission mode
- Standard Claude Code modes (define once, reference everywhere):
  - default
  - plan-mode
  - dangerously-skip-permissions
- Simple confirmation dialog when selecting "dangerously-skip-permissions"

### 5. Refresh Session List
- Button in sidebar header (refresh icon)
- Pull-to-refresh on mobile (basic touch handler or CSS overscroll approach)

### 6. Directory Selection Modal Fix
- Root cause: Single-modal implementation causes dir picker to close parent modal
- Solution: Allow child modals to stack; non-child modals replace the stack
- New session modal should remain open when directory picker opens

### 7. Auto-Naming Sessions
- When: At session creation time (not lazy/display-only)
- Source: First 128 characters of first user message
- Only applies if no name is explicitly provided

## Technical Approach

### Library Loading
- Add Fuse.js to `public/js/lib/` (following existing pattern for marked.js, highlight.js)

### Permission Modes Constant
- Define permission modes once in a constants file or at top of app.js
- All permission-related code references this single definition

### Modal Stacking System
- Refactor modal system to support parent-child relationships
- Child modals stack on top of parent
- Non-related modals replace the entire stack
- Track modal hierarchy in state

### Fuse.js Configuration
- Search keys: session name, workdir path
- Balanced threshold (not too strict, not too lenient)
- Include score for potential ranking

### Pull-to-Refresh
- Basic touch event handling (touchstart/touchmove/touchend)
- Or CSS overscroll-behavior if it provides acceptable UX
- Keep implementation simple

## Open Questions

- Exact visual design for the (+) button (icon only? with text?)
- Specific Fuse.js threshold value (will tune during implementation)
- Detailed view toggle state persistence (session storage? per-session?)

## Acceptance Criteria

- [ ] Per-workdir (+) button visible inline with workdir headers
- [ ] Clicking (+) opens new session modal with workdir pre-populated
- [ ] Search box filters sessions using fuzzy matching
- [ ] Cmd/Ctrl+K focuses search, Escape clears, arrow keys navigate
- [ ] Matching workdirs auto-expand during search
- [ ] Detailed view button toggles agent activity visibility
- [ ] Permission mode dropdown visible in session header
- [ ] Changing to dangerously-skip-permissions shows confirmation
- [ ] Refresh button in sidebar header reloads session list
- [ ] Pull-to-refresh works on mobile
- [ ] Directory picker doesn't close new session modal
- [ ] Unnamed sessions get auto-named from first message (max 128 chars)
- [ ] Each feature committed incrementally
- [ ] Documentation created in docs/ with Playwright screenshots
